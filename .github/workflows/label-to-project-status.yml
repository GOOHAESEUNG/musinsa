name: Update Project Status by Label

on:
  issues:
    types: [labeled]

jobs:
  update-project-status:
    runs-on: ubuntu-latest
    steps:
      - name: Check label and update project status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PROJECT_TOKEN }}
          script: |
            const label = context.payload.label.name;
            const issueNodeId = context.payload.issue.node_id;

            const PROJECT_NUMBER = 1; // 너의 Project 번호
            const ORG = '사용자명 또는 조직명'; // 예: 'haeseung-musinsa'
            const FIELD_ID = '필드 ID'; // Status 필드 ID
            const STATUS_VALUES = {
              "🚧 진행 중": "인프로그레스 ID",
              "✅ 완료됨": "던 ID"
            };

            if (!STATUS_VALUES[label]) {
              console.log(`해당 라벨은 자동처리 대상이 아님: ${label}`);
              return;
            }

            const { data: projects } = await github.graphql(`
              query {
                organization(login: "${ORG}") {
                  projectV2(number: ${PROJECT_NUMBER}) {
                    id
                  }
                }
              }
            `);

            const projectId = projects.organization.projectV2.id;
            console.log("✅ Project ID:", projectId);

            await github.graphql(`
              mutation {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: "${projectId}"
                    itemId: "${issueNodeId}"
                    fieldId: "${FIELD_ID}"
                    value: {
                      singleSelectOptionId: "${STATUS_VALUES[label]}"
                    }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `);