name: Update Project Status on Label

on:
  issues:
    types: [labeled]

jobs:
  update-project-status:
    runs-on: ubuntu-latest
    steps:
      - name: Check label and update project status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PROJECT_TOKEN }}
          script: |
            const label = context.payload.label.name;
            const issueNumber = context.payload.issue.number;
            const repository = context.payload.repository.full_name;
            const [owner, repo] = repository.split('/');

            const PROJECT_NUMBER = 1;
            const LOGIN = 'GOOHAESEUNG';  // ì‚¬ìš©ì ë¡œê·¸ì¸ ë˜ëŠ” ì¡°ì§ëª…
            const FIELD_ID = 'PVTSSF_lAHOB1FNEc4Asorvzgjhx4s';
            const STATUS_VALUES = {
              "ğŸš§ ì§„í–‰ ì¤‘": "47fc9ee4",
              "âœ… ì™„ë£Œë¨": "98236657"
            };

            if (!STATUS_VALUES[label]) {
              console.log(`í•´ë‹¹ ë¼ë²¨ì€ ìë™ì²˜ë¦¬ ëŒ€ìƒì´ ì•„ë‹˜: ${label}`);
              return;
            }

            try {
              // Step 1: í”„ë¡œì íŠ¸ ID ê°€ì ¸ì˜¤ê¸°
              console.log(`í”„ë¡œì íŠ¸ ì •ë³´ ì¡°íšŒ ì¤‘...`);
              const projectQuery = await github.graphql(`
                query {
                  user(login: "${LOGIN}") {
                    projectV2(number: ${PROJECT_NUMBER}) {
                      id
                    }
                  }
                }
              `);
            
              const projectId = projectQuery.user.projectV2.id;
              console.log(`í”„ë¡œì íŠ¸ ID: ${projectId}`);
            
              // Step 2: ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
              console.log(`ì´ìŠˆ ì •ë³´ ì¡°íšŒ ì¤‘... (ì €ì¥ì†Œ: ${repository}, ì´ìŠˆ ë²ˆí˜¸: ${issueNumber})`);
              const issueQuery = await github.graphql(`
                query {
                  repository(owner: "${owner}", name: "${repo}") {
                    issue(number: ${issueNumber}) {
                      id
                      title
                    }
                  }
                }
              `);
            
              const issueId = issueQuery.repository.issue.id;
              console.log(`ì´ìŠˆ ID: ${issueId}, ì œëª©: ${issueQuery.repository.issue.title}`);
            
              // Step 3: í”„ë¡œì íŠ¸ì—ì„œ ì´ìŠˆ í•­ëª© ì°¾ê¸°
              console.log(`í”„ë¡œì íŠ¸ì—ì„œ ì´ìŠˆ í•­ëª© ì°¾ëŠ” ì¤‘...`);
              const itemsQuery = await github.graphql(`
                query {
                  node(id: "${projectId}") {
                    ... on ProjectV2 {
                      items(first: 100) {
                        nodes {
                          id
                          content {
                            ... on Issue {
                              id
                              number
                              title
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `);
            
              const projectItems = itemsQuery.node.items.nodes;
              const matchingItem = projectItems.find(item => 
                item.content && item.content.id === issueId
              );
            
              if (!matchingItem) {
                console.log(`âš ï¸ í”„ë¡œì íŠ¸ì— í•´ë‹¹ ì´ìŠˆê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¨¼ì € ì´ìŠˆë¥¼ í”„ë¡œì íŠ¸ì— ì¶”ê°€í•´ì£¼ì„¸ìš”.`);
            
                // Step 4: í”„ë¡œì íŠ¸ì— ì´ìŠˆ ì¶”ê°€ (ì„ íƒì‚¬í•­)
                console.log(`ì´ìŠˆë¥¼ í”„ë¡œì íŠ¸ì— ì¶”ê°€í•©ë‹ˆë‹¤...`);
                const addResult = await github.graphql(`
                  mutation {
                    addProjectV2ItemById(input: {
                      projectId: "${projectId}"
                      contentId: "${issueId}"
                    }) {
                      item {
                        id
                      }
                    }
                  }
                `);
            
                const itemId = addResult.addProjectV2ItemById.item.id;
                console.log(`âœ… ì´ìŠˆê°€ í”„ë¡œì íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. í•­ëª© ID: ${itemId}`);
            
                // ì¶”ê°€ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸
                await github.graphql(`
                  mutation {
                    updateProjectV2ItemFieldValue(
                      input: {
                        projectId: "${projectId}"
                        itemId: "${itemId}"
                        fieldId: "${FIELD_ID}"
                        value: {
                          singleSelectOptionId: "${STATUS_VALUES[label]}"
                        }
                      }
                    ) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `);
                console.log(`âœ… í•­ëª© ìƒíƒœê°€ '${label}'ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
              } else {
                // ì´ë¯¸ í”„ë¡œì íŠ¸ì— ìˆëŠ” ì´ìŠˆ ìƒíƒœ ì—…ë°ì´íŠ¸
                const itemId = matchingItem.id;
                console.log(`âœ… í”„ë¡œì íŠ¸ì—ì„œ ì´ìŠˆë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. í•­ëª© ID: ${itemId}`);
            
                await github.graphql(`
                  mutation {
                    updateProjectV2ItemFieldValue(
                      input: {
                        projectId: "${projectId}"
                        itemId: "${itemId}"
                        fieldId: "${FIELD_ID}"
                        value: {
                          singleSelectOptionId: "${STATUS_VALUES[label]}"
                        }
                      }
                    ) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `);
                console.log(`âœ… í•­ëª© ìƒíƒœê°€ '${label}'ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
              }
            } catch (error) {
              console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
              console.log('ì˜¤ë¥˜ ì„¸ë¶€ì •ë³´:', JSON.stringify(error, null, 2));
            }